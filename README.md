# 基于ZKP的匿名投票系统

## 项目概述

本项目实现了一个基于零知识证明（ZKP）的匿名投票系统，使用zk-SNARKs算法来确保投票的匿名性和可验证性。系统采用分层架构设计，支持异步并发处理，并通过混合网络和区块链技术进一步增强隐私保护。系统支持多链部署，可配置地支持各种兼容Solidity的区块链网络。

## 系统架构

### 整体架构
```
前端应用 → 混合网络层 → 后端服务 → 消息队列 → 智能合约 → 多链网络
```

### 核心组件

1. **前端应用**
   - 用户界面：提供投票和结果查看功能
   - 异步通信：与后端API交互
   - 匿名网络：通过混合网络发送请求
   - 多链支持：可选择不同的区块链网络
   - Gas费用优化：支持中继器模式选择

2. **后端服务**
   - 异步处理：处理用户请求和投票逻辑
   - ZKP验证：生成和验证零知识证明
   - 区块链交互：与多链智能合约通信
   - 混合网络集成：支持匿名通信

3. **智能合约**
   - 部署在多条区块链上
   - 验证投票证明
   - 防止重复投票
   - 存储投票结果
   - 支持链配置管理
   - 中继器模式支持

4. **ZKP电路**
   - 定义投票逻辑约束
   - 生成和验证零知识证明
   - 防重机制实现

## 技术栈

### 后端
- **Rust**: 系统核心实现
- **arkworks**: ZKP算法库
- **Tokio**: 异步运行时
- **Warp**: Web框架

### 前端
- **Next.js**: React框架
- **TypeScript**: 类型安全
- **Tailwind CSS**: 样式设计

### 区块链
- **Solidity**: 智能合约语言
- **Hardhat**: 开发环境
- **ethers.js**: 与多链交互

## 核心功能

### 1. 匿名投票
- 使用zk-SNARKs确保投票内容不被泄露
- 验证者无法得知具体投票选择
- 投票者身份与投票内容分离
- 防重标识确保一人一票

### 2. 防重机制
- 使用nullifier防止重复投票
- 每个用户只能投票一次
- 防重标识与投票内容无关
- 链上验证防重机制

### 3. 混合网络
- 通过混合网络发送投票请求
- 打乱时间顺序和网络路径
- 防止网络层面的信息关联
- 增强用户隐私保护

### 4. 异步处理
- 支持高并发请求处理
- 异步生成ZKP证明
- 非阻塞式操作
- 提升系统性能

### 5. 多链支持
- 可配置地支持多种区块链网络
- 统一的接口适配不同链
- 支持链配置管理
- 灵活的网络选择

### 6. Gas费用优化
- 中继器模式降低用户成本
- 批量处理减少Gas消耗
- 支持多链Gas费用估算
- 经济激励机制

### 7. 安全特性
- 零知识证明：投票内容完全匿名
- 混合网络：防止网络关联
- 随机化电路：增加混淆效果
- 防重机制：防止重复投票
- 输入验证：防止恶意输入
- 内容安全策略：防止XSS攻击
- 链配置管理：支持多链安全部署

## 多链支持

### 支持的区块链网络
1. **以太坊主网和测试网** (Goerli)
2. **Binance Smart Chain** (主网和测试网)
3. **Polygon** (主网)
4. **本地测试网络** (Hardhat/Ganache)

### 配置方式
- 通过环境变量配置RPC节点
- 合约内链配置管理
- 前端可选择不同链进行投票
- 支持链配置的动态更新

## 部署指南

### 环境要求
- Rust 1.70+
- Node.js 16+
- Hardhat
- 支持的区块链客户端

### 后端部署
```bash
# 安装依赖
cargo build

# 运行后端服务
cargo run
```

### 前端部署
```bash
cd frontend
npm install
npm run dev
```

### 区块链部署
```bash
cd blockchain
npm install

# 部署到本地网络
npx hardhat compile
npx hardhat run scripts/deploy.js --network localhost

# 部署到其他网络（需要配置环境变量）
npx hardhat run scripts/deploy.js --network goerli
```

### 环境变量配置
```bash
# .env文件示例
INFURA_PROJECT_ID=your_infura_project_id
PRIVATE_KEY=your_private_key
BSC_RPC_URL=your_bsc_rpc_url
POLYGON_RPC_URL=your_polygon_rpc_url
```

## API接口

### 投票接口
- **POST /api/vote**: 提交投票
- **GET /api/results**: 获取投票结果

### 参数说明
- `vote`: 投票选择 (0 或 1)
- `user_id`: 用户ID
- `proof`: ZKP证明数据
- `nullifier`: 防重标识
- `chain`: 区块链网络选择
- `gas_option`: Gas费用支付方式 ('direct' 或 'relayer')

## 使用示例

### 投票流程
1. 用户访问投票页面
2. 选择投票选项和区块链网络
3. 选择Gas费用支付方式
4. 系统生成ZKP证明
5. 通过混合网络提交证明
6. 智能合约验证并记录结果

### 结果查询
1. 用户访问结果页面
2. 系统从指定区块链获取最新结果
3. 展示统计信息和可视化图表

## 项目结构

```
zkp-vote/
├── src/                 # 后端Rust代码
│   ├── lib.rs          # 核心ZKP逻辑
│   ├── web.rs          # Web服务
│   └── test.rs         # 测试代码
├── frontend/           # 前端代码
│   ├── pages/          # 页面组件
│   ├── lib/            # 工具函数
│   └── styles/         # 样式文件
├── blockchain/         # 区块链组件
│   ├── contracts/      # 智能合约
│   ├── src/            # 区块链接口
│   ├── scripts/        # 部署脚本
│   └── test/           # 区块链测试
├── Cargo.toml          # Rust依赖配置
└── README.md
```

## 配置文件说明

### 区块链配置
- `hardhat.config.js`: 多链网络配置
- `scripts/deploy.js`: 部署脚本，支持多链部署
- `src/blockchain-interface.ts`: 统一的区块链接口

### 智能合约
- `contracts/Vote.sol`: 支持多链和中继器模式的智能合约
- 包含链配置管理功能
- 支持批量投票处理

### 中继器服务
- `src/relayer.ts`: 多链中继器服务
- 支持多链Gas费用优化
- 统一的投票处理接口

## 测试

### 单元测试
- ZKP电路测试
- 后端逻辑测试
- 前端组件测试

### 集成测试
- 端到端测试
- 区块链集成测试
- 多链兼容性测试

### Gas优化测试
- 不同链的Gas消耗对比
- 批量处理效率测试
- 中继器模式成本分析

### 安全测试
- 零知识证明验证测试
- 防重机制测试
- 混合网络匿名性测试

## 未来改进

1. **性能优化**: 优化ZKP生成和验证算法
2. **扩展性**: 支持更多投票选项和复杂投票规则
3. **用户体验**: 改进前端界面和交互体验
4. **安全性**: 增强防攻击能力
5. **多链支持**: 增加对更多区块链网络的支持
6. **Gas优化**: 进一步降低用户投票成本
7. **可扩展性**: 支持更大规模的投票活动
8. **审计**: 智能合约安全审计

## 贡献

欢迎提交Issue和Pull Request来改进本项目。

## 许可证

MIT License